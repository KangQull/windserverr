#!/bin/bash

# Direktori mount
MOUNT_DIR="/mnt/recovery"
WINDOWS_GZ_URL="https://cloudshydro.tech/s/2PRRktGXTt4DJ2w/download/win1124H2xLite.gz"

# Fungsi untuk mendapatkan informasi IP, netmask, dan gateway
get_network_info() {
    # Mendapatkan IP Address
    IP_ADDR=$(ip addr show eth0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
    if [ -z "$IP_ADDR" ]; then
        echo "Error: Tidak dapat mendeteksi alamat IP. Pastikan interface eth0 ada."
        exit 1
    fi

    # Mendapatkan Netmask (CIDR)
    NETMASK=$(ip addr show eth0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f2)
    
    # Mendapatkan Gateway
    GATEWAY=$(ip route | grep default | awk '{print $3}')
    if [ -z "$GATEWAY" ]; then
        echo "Error: Tidak dapat mendeteksi gateway."
        exit 1
    fi

    # Menampilkan hasil deteksi
    echo "Alamat IP: $IP_ADDR"
    echo "Netmask: /$NETMASK"
    echo "Gateway: $GATEWAY"
}

# Menjalankan deteksi jaringan
get_network_info

# Membuat direktori mount jika belum ada
mkdir -p $MOUNT_DIR/etc/cloud

# Menulis konfigurasi cloud-init dengan IP, netmask, dan gateway yang terdeteksi
echo "Menulis konfigurasi cloud-init ke $MOUNT_DIR/etc/cloud/cloud.cfg..."

cat <<EOF > $MOUNT_DIR/etc/cloud/cloud.cfg
#cloud-config
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: false
      addresses:
        - $IP_ADDR/$NETMASK  # Menetapkan alamat IP dan netmask
      gateway4: $GATEWAY    # Menetapkan gateway
      nameservers:
        addresses:
          - 8.8.8.8        # DNS pertama
          - 8.8.4.4        # DNS kedua
EOF

# Memastikan cloud-init terpasang
echo "Memastikan cloud-init terpasang..."
apt-get update
apt-get install -y cloud-init

# Mount disk jika diperlukan (menggunakan disk terdeteksi)
echo "Mounting disk..."
ROOT_DISK=$(lsblk -n -o NAME,MOUNTPOINT | grep -w "/" | awk '{print $1}')
DISK_PATH="/dev/$ROOT_DISK"

if [ ! -b "$DISK_PATH" ]; then
    echo "Error: Disk root tidak ditemukan. Silakan periksa konfigurasi disk."
    exit 1
fi

mount $DISK_PATH $MOUNT_DIR
if [ $? -ne 0 ]; then
    echo "Error: Gagal mounting disk $DISK_PATH."
    exit 1
fi

# Mengunduh dan menulis image Windows ke disk
echo "Mengunduh dan menulis Windows image ke disk..."
wget -qO- $WINDOWS_GZ_URL | gunzip -c | dd of=$DISK_PATH bs=1M status=progress
if [ $? -ne 0 ]; then
    echo "Error: Gagal mengunduh atau menulis image ke disk."
    umount $MOUNT_DIR
    exit 1
fi

# Sinkronkan data ke disk
sync

# Unmount disk setelah selesai
umount $MOUNT_DIR

# Reboot sistem
echo "Sistem akan reboot sekarang..."
